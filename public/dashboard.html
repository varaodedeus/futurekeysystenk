<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AuthGuard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #0a0e1a; color: #fff; min-height: 100vh; }
        nav { background: #1a1f35; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2a3550; }
        nav h1 { color: #0ea5e9; font-size: 24px; }
        .logout { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .tabs { display: flex; gap: 10px; padding: 20px 40px; background: #1a1f35; border-bottom: 2px solid #2a3550; }
        .tab { padding: 12px 24px; background: transparent; border: none; color: #94a3b8; cursor: pointer; border-bottom: 3px solid transparent; font-size: 16px; }
        .tab.active { color: #0ea5e9; border-bottom-color: #0ea5e9; }
        .container { padding: 40px; max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h2 { font-size: 32px; }
        .btn { background: #0ea5e9; color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; }
        .btn:hover { background: #0284c7; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: #1a1f35; padding: 24px; border-radius: 12px; border: 1px solid #2a3550; }
        .card h3 { font-size: 20px; margin-bottom: 10px; }
        .card p { color: #94a3b8; font-size: 14px; margin: 8px 0; }
        .badges { display: flex; gap: 8px; margin: 15px 0; }
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 12px; background: #2a3550; }
        .actions { display: flex; gap: 8px; margin-top: 15px; }
        .btn-small { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1; }
        .btn-view { background: #0ea5e9; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-box { background: #1a1f35; padding: 30px; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-box h3 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #94a3b8; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; color: white; font-size: 14px; }
        .form-group textarea { min-height: 400px; font-family: 'Courier New', monospace; font-size: 12px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .empty { text-align: center; padding: 60px; color: #64748b; }
        .code-box { background: #0a0e1a; padding: 15px; border-radius: 8px; margin: 15px 0; word-break: break-all; font-family: monospace; color: #10b981; max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <nav>
        <h1>üîê AuthGuard</h1>
        <div>
            <span id="username" style="margin-right: 20px; color: #94a3b8;"></span>
            <button class="logout" onclick="logout()">Sair</button>
        </div>
    </nav>
    
    <div class="tabs">
        <button class="tab active" onclick="switchTab('projects')">üìÅ Projetos</button>
        <button class="tab" onclick="switchTab('keys')">üîë Keys</button>
    </div>
    
    <div class="container">
        <div id="tab-projects" class="tab-content active">
            <div class="header">
                <h2>Meus Projetos</h2>
                <button class="btn" onclick="openModal('project')">+ Novo Projeto</button>
            </div>
            <div id="projectsGrid" class="grid"></div>
        </div>
        
        <div id="tab-keys" class="tab-content">
            <div class="header">
                <h2>Minhas Keys</h2>
                <button class="btn" onclick="openModal('key')">+ Gerar Key</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="color: #94a3b8; display: block; margin-bottom: 8px;">Selecione o Projeto:</label>
                <select id="projectSelect" onchange="loadKeys()" style="width: 300px; padding: 10px; background: #1a1f35; border: 1px solid #2a3550; border-radius: 8px; color: white;">
                    <option value="">Selecione...</option>
                </select>
            </div>
            <div id="keysGrid" class="grid"></div>
        </div>
    </div>
    
    <div id="modalProject" class="modal">
        <div class="modal-box">
            <h3>Criar Projeto</h3>
            <div class="form-group">
                <label>Nome *</label>
                <input type="text" id="projectName" placeholder="Meu Script">
            </div>
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <textarea id="projectDesc" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('project')">Cancelar</button>
                <button class="btn" onclick="createProject()">Criar</button>
            </div>
        </div>
    </div>
    
    <div id="modalKey" class="modal">
        <div class="modal-box">
            <h3>Gerar Key</h3>
            <div class="form-group">
                <label>Projeto *</label>
                <select id="keyProject">
                    <option value="">Selecione...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dura√ß√£o (dias) *</label>
                <input type="number" id="keyDuration" value="30" min="0">
                <small style="color: #64748b;">0 = Lifetime</small>
            </div>
            <div class="form-group">
                <label>Nota</label>
                <input type="text" id="keyNote" placeholder="Cliente Jo√£o">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('key')">Cancelar</button>
                <button class="btn" onclick="generateKey()">Gerar</button>
            </div>
        </div>
    </div>
    
    <div id="modalLoader" class="modal">
        <div class="modal-box">
            <h3>üìã Loader Code</h3>
            <p style="color: #94a3b8; margin: 10px 0;">Cole TODO este c√≥digo:</p>
            <div class="form-group">
                <textarea id="loaderCode" readonly style="font-size: 11px;"></textarea>
            </div>
            <p style="color: #64748b; font-size: 13px; margin: 10px 0;">
                1. Copie TODO o c√≥digo acima<br>
                2. Edite o campo <code>local YOUR_SCRIPT = [[]]</code><br>
                3. Cole SEU script dentro do [[]]<br>
                4. Compartilhe no Pastebin
            </p>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal('loader')">Fechar</button>
                <button class="btn" onclick="copyLoader()">üìã Copiar C√≥digo</button>
            </div>
        </div>
    </div>
    
    <script>
        let token = localStorage.getItem('token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let projects = [];
        let selectedProject = null;
        
        if (!token) window.location.href = '/';
        document.getElementById('username').textContent = user.username || 'User';
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            if (tab === 'projects') loadProjects();
            if (tab === 'keys') {
                loadProjects().then(() => {
                    const sel = document.getElementById('projectSelect');
                    sel.innerHTML = '<option value="">Selecione...</option>' + 
                        projects.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
                });
            }
        }
        
        async function loadProjects() {
            const res = await fetch('/api/list-projects', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.success) {
                projects = data.projects;
                const grid = document.getElementById('projectsGrid');
                if (projects.length === 0) {
                    grid.innerHTML = '<div class="empty"><h3>Nenhum projeto</h3></div>';
                } else {
                    grid.innerHTML = projects.map(p => `
                        <div class="card">
                            <h3>${p.name}</h3>
                            <p>${p.description || 'Sem descri√ß√£o'}</p>
                            <div class="badges">
                                <span class="badge">${p.stats?.totalKeys || 0} Keys</span>
                                <span class="badge">${p.stats?.activeKeys || 0} Ativas</span>
                            </div>
                            <div class="actions">
                                <button class="btn-small btn-view" onclick="viewLoader('${p._id}')">üìã Loader</button>
                                <button class="btn-small btn-delete" onclick="deleteProject('${p._id}', '${p.name}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
        
        function openModal(type) {
            if (type === 'key') {
                const sel = document.getElementById('keyProject');
                sel.innerHTML = '<option value="">Selecione...</option>' + 
                    projects.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
            }
            document.getElementById('modal' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('show');
        }
        
        function closeModal(type) {
            document.getElementById('modal' + type.charAt(0).toUpperCase() + type.slice(1)).classList.remove('show');
        }
        
        async function createProject() {
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDesc').value;
            if (!name) return alert('Digite o nome!');
            const res = await fetch('/api/create-project', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ name, description })
            });
            if (res.ok) {
                closeModal('project');
                document.getElementById('projectName').value = '';
                document.getElementById('projectDesc').value = '';
                loadProjects();
            }
        }
        
        async function deleteProject(id, name) {
            if (!confirm(`Deletar ${name}?`)) return;
            await fetch('/api/delete-project', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ projectId: id })
            });
            loadProjects();
        }
        
        async function viewLoader(id) {
            const url = window.location.origin + '/loader/' + id;
            const res = await fetch(url);
            const code = await res.text();
            document.getElementById('loaderCode').value = code;
            document.getElementById('modalLoader').classList.add('show');
        }
        
        function copyLoader() {
            const code = document.getElementById('loaderCode');
            code.select();
            document.execCommand('copy');
            alert('‚úÖ C√≥digo copiado!');
        }
        
        async function loadKeys() {
            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) {
                document.getElementById('keysGrid').innerHTML = '<div class="empty"><h3>Selecione um projeto</h3></div>';
                return;
            }
            selectedProject = projectId;
            const res = await fetch(`/api/list-keys?projectId=${projectId}`, { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.success) {
                const grid = document.getElementById('keysGrid');
                if (data.keys.length === 0) {
                    grid.innerHTML = '<div class="empty"><h3>Nenhuma key</h3></div>';
                } else {
                    grid.innerHTML = data.keys.map(k => `
                        <div class="card">
                            <h3 style="font-family: monospace; color: #0ea5e9;">${k.key}</h3>
                            <p>Status: ${k.status.toUpperCase()}</p>
                            <p>Dura√ß√£o: ${k.duration === 0 ? 'Lifetime' : k.duration + ' dias'}</p>
                            <p>Usos: ${k.usageCount || 0}</p>
                            ${k.note ? `<p>Nota: ${k.note}</p>` : ''}
                            <div class="actions">
                                ${k.hwid ? `<button class="btn-small btn-view" onclick="resetHWID('${k._id}')">üîÑ Reset</button>` : ''}
                                <button class="btn-small btn-delete" onclick="deleteKey('${k._id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
        
        async function generateKey() {
            const projectId = document.getElementById('keyProject').value;
            const duration = document.getElementById('keyDuration').value;
            const note = document.getElementById('keyNote').value;
            if (!projectId) return alert('Selecione o projeto!');
            const res = await fetch('/api/generate-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ projectId, duration, note })
            });
            if (res.ok) {
                alert('‚úÖ Key gerada!');
                closeModal('key');
                document.getElementById('keyDuration').value = '30';
                document.getElementById('keyNote').value = '';
                if (selectedProject === projectId) loadKeys();
            }
        }
        
        async function resetHWID(keyId) {
            if (!confirm('Resetar HWID?')) return;
            await fetch('/api/reset-hwid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ keyId })
            });
            alert('‚úÖ Resetado!');
            loadKeys();
        }
        
        async function deleteKey(keyId) {
            if (!confirm('Deletar key?')) return;
            await fetch('/api/delete-key', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ keyId })
            });
            alert('‚úÖ Deletada!');
            loadKeys();
        }
        
        function logout() { localStorage.clear(); window.location.href = '/'; }
        
        window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.classList.remove('show'); }
        
        loadProjects();
    </script>
</body>
</html>
