let token = localStorage.getItem('token');
let user = JSON.parse(localStorage.getItem('user') || '{}');
let allProjects = [];
let currentKeyProject = null;

if (!token) window.location.href = '/';

document.getElementById('username').textContent = user.username || 'Usu√°rio';

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`tab-${tab}`).classList.add('active');

    if (tab === 'projects') loadProjects();
    if (tab === 'keys') loadProjectsForKeys();
}

async function loadProjects() {
    try {
        const res = await fetch('/api/list-projects', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.success) {
            allProjects = data.projects;
            const grid = document.getElementById('projectsGrid');
            
            if (data.projects.length === 0) {
                grid.innerHTML = '<div class="empty-state"><h3>Nenhum projeto ainda</h3><p>Crie seu primeiro projeto!</p></div>';
            } else {
                grid.innerHTML = data.projects.map(p => `
                    <div class="card">
                        <h3>${p.name}</h3>
                        <p>${p.description || 'Sem descri√ß√£o'}</p>
                        <div class="stats-badges">
                            <span class="badge badge-size">${p.stats?.totalKeys || 0} Keys</span>
                            <span class="badge badge-active">${p.stats?.activeKeys || 0} Ativas</span>
                            <span class="badge badge-executions">${p.stats?.totalValidations || 0} Valida√ß√µes</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn-small btn-view" onclick="viewLoader('${p._id}')">üìã Ver Loader</button>
                            <button class="btn-small btn-analytics" onclick="viewAnalytics('${p._id}', '${p.name.replace(/'/g, "\\'")}')">üìä Analytics</button>
                            <button class="btn-small btn-delete" onclick="deleteProject('${p._id}', '${p.name.replace(/'/g, "\\'")}')">üóëÔ∏è Deletar</button>
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar projetos:', error);
    }
}

function viewLoader(projectId) {
    const host = window.location.origin;
    const loaderURL = `${host}/loader/${projectId}`;
    
    document.getElementById('loaderTitle').textContent = `üìã Loader URL`;
    document.getElementById('loaderCodeContent').textContent = loaderURL;
    
    showModal('viewLoader');
}

async function createProject(e) {
    e.preventDefault();
    const name = document.getElementById('projectNameInput').value;
    const description = document.getElementById('projectDescInput').value;

    try {
        const res = await fetch('/api/create-project', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ name, description })
        });

        if (res.ok) {
            closeModal('createProject');
            document.getElementById('formCreateProject').reset();
            await loadProjects();
        }
    } catch (error) {
        alert('Erro ao criar projeto');
    }
}

async function deleteProject(projectId, projectName) {
    if (!confirm(`Deletar "${projectName}" permanentemente?\n\nIsso vai deletar TODAS as keys deste projeto!`)) return;

    try {
        const res = await fetch('/api/delete-project', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ projectId })
        });

        const data = await res.json();

        if (data.success) {
            alert('‚úÖ Projeto deletado!');
            await loadProjects();
        } else {
            alert('Erro: ' + data.error);
        }
    } catch (error) {
        alert('Erro ao deletar projeto');
    }
}

async function viewAnalytics(projectId, projectName) {
    try {
        const res = await fetch(`/api/analytics/${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.success) {
            document.getElementById('analyticsTitle').textContent = `üìä Analytics - ${projectName}`;
            
            const dates = Object.keys(data.analytics).map(d => {
                const date = new Date(d);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });
            
            const keysCreated = Object.values(data.analytics).map(d => d.keysCreated);
            const keysActivated = Object.values(data.analytics).map(d => d.keysActivated);
            const executions = Object.values(data.analytics).map(d => d.executions);
            
            createWeekStatsChart(dates, keysCreated, keysActivated);
            createExecutionsChart(dates, keysActivated, executions);
            
            showModal('analytics');
        }
    } catch (error) {
        console.error('Erro ao carregar analytics:', error);
        alert('Erro ao carregar analytics');
    }
}

let weekStatsChart = null;
let executionsChart = null;

function createWeekStatsChart(labels, keysCreated, keysActivated) {
    const ctx = document.getElementById('chartWeekStats');
    
    if (weekStatsChart) weekStatsChart.destroy();
    
    weekStatsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Keys Created',
                    data: keysCreated,
                    borderColor: '#8b5cf6',
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Keys Activated',
                    data: keysActivated,
                    borderColor: '#0ea5e9',
                    backgroundColor: 'rgba(14, 165, 233, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { labels: { color: '#94a3b8' } } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
            }
        }
    });
}

function createExecutionsChart(labels, premium, defaultKeys) {
    const ctx = document.getElementById('chartExecutions');
    
    if (executionsChart) executionsChart.destroy();
    
    executionsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Active Keys',
                    data: premium,
                    backgroundColor: 'rgba(139, 92, 246, 0.6)',
                    borderColor: '#8b5cf6',
                    borderWidth: 1
                },
                {
                    label: 'Executions',
                    data: defaultKeys,
                    backgroundColor: 'rgba(14, 165, 233, 0.6)',
                    borderColor: '#0ea5e9',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { labels: { color: '#94a3b8' } } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
            }
        }
    });
}

async function loadProjectsForKeys() {
    await loadProjects();
    const select = document.getElementById('keyProjectSelect');
    
    select.innerHTML = '<option value="">Selecione um projeto</option>' +
        allProjects.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
}

async function loadKeys() {
    const projectId = document.getElementById('keyProjectSelect').value;
    if (!projectId) {
        document.getElementById('keysGrid').innerHTML = '<div class="empty-state"><h3>Selecione um projeto</h3></div>';
        return;
    }

    currentKeyProject = projectId;

    try {
        const res = await fetch(`/api/list-keys?projectId=${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        
        if (data.success) {
            const grid = document.getElementById('keysGrid');
            
            if (data.keys.length === 0) {
                grid.innerHTML = '<div class="empty-state"><h3>Nenhuma key ainda</h3><p>Gere sua primeira key!</p></div>';
            } else {
                grid.innerHTML = data.keys.map(k => {
                    const statusBadge = k.status === 'active' ? 'badge-active' : 
                                        k.status === 'pending' ? 'badge-pending' : 'badge-size';
                    return `
                    <div class="card">
                        <h3 class="card-code">${k.key}</h3>
                        <p>Status: <span class="badge ${statusBadge}">${k.status.toUpperCase()}</span></p>
                        <p>Dura√ß√£o: ${k.duration === 0 ? 'Lifetime' : k.duration + ' dias'}</p>
                        <p>Expira: ${k.expiresAt ? new Date(k.expiresAt).toLocaleDateString() : 'Aguardando uso'}</p>
                        <p>Usos: ${k.usageCount || 0}</p>
                        ${k.note ? `<p>Nota: ${k.note}</p>` : ''}
                        <div class="card-actions">
                            ${k.hwid ? `<button class="btn-small btn-view" onclick="resetHWID('${k._id}')">üîÑ Reset HWID</button>` : ''}
                            <button class="btn-small btn-delete" onclick="deleteKey('${k._id}')">üóëÔ∏è Deletar</button>
                        </div>
                    </div>
                `}).join('');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar keys:', error);
    }
}

async function generateKey(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('generateKeyProjectSelect').value;
    
    if (!projectId) {
        alert('Selecione um projeto!');
        return;
    }

    const duration = document.getElementById('keyDurationInput').value;
    const note = document.getElementById('keyNoteInput').value;

    try {
        const res = await fetch('/api/generate-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ projectId: projectId, duration, note })
        });

        if (res.ok) {
            alert('‚úÖ Key gerada com sucesso!');
            closeModal('generateKey');
            document.getElementById('formGenerateKey').reset();
            
            // Se tiver um projeto selecionado na aba Keys, recarrega
            if (currentKeyProject === projectId) {
                await loadKeys();
            }
        }
    } catch (error) {
        alert('Erro ao gerar key');
    }
}

async function resetHWID(keyId) {
    if (!confirm('Resetar o HWID desta key?')) return;

    try {
        const res = await fetch('/api/reset-hwid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ keyId })
        });

        if (res.ok) {
            alert('‚úÖ HWID resetado!');
            await loadKeys();
        }
    } catch (error) {
        alert('Erro ao resetar HWID');
    }
}

async function deleteKey(keyId) {
    if (!confirm('Deletar esta key permanentemente?')) return;

    try {
        const res = await fetch('/api/delete-key', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ keyId })
        });

        if (res.ok) {
            alert('‚úÖ Key deletada!');
            await loadKeys();
        }
    } catch (error) {
        alert('Erro ao deletar key');
    }
}

function showModal(modal) {
    const modalId = 'modal' + modal.charAt(0).toUpperCase() + modal.slice(1);
    
    // Se for modal de gerar key, popula o select
    if (modal === 'generateKey') {
        const select = document.getElementById('generateKeyProjectSelect');
        select.innerHTML = '<option value="">Selecione um projeto</option>' +
            allProjects.map(p => `<option value="${p._id}">${p.name}</option>`).join('');
        
        // Se j√° tem um projeto selecionado na aba Keys, pre-seleciona
        if (currentKeyProject) {
            select.value = currentKeyProject;
        }
    }
    
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modal) {
    const modalId = 'modal' + modal.charAt(0).toUpperCase() + modal.slice(1);
    document.getElementById(modalId).classList.remove('show');
}

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    window.location.href = '/';
}

function copyLoaderCode() {
    const code = document.getElementById('loaderCodeContent').textContent;
    navigator.clipboard.writeText(code).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copiado!';
        btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    });
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
    }
}

loadProjects();
